<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel del Alumno</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- CABECERA CON LOGO -->
  <header class="top-bar">
    <div class="logo-area">
      <img src="logo.png" alt="Logo Escuela" class="logo" />
      <h1 class="titulo-escuela">Escuela Sab√°tica</h1>
    </div>
  </header>

  <div class="container">
    <h2>Bienvenido (a): <span id="nombreAlumno"></span></h2>
    <p>Clase: <span id="nombreClase"></span></p>

    <!-- Nueva secci√≥n para los d√≠as de estudio -->
    <div id="semana-estudios" class="semana-estudios">
      <!-- Botones para seleccionar el d√≠a -->
    </div>

    <div class="study-card">
      <!-- Aqu√≠ se mostrar√°n los estudios del d√≠a seleccionado -->
    </div>

    <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
  </div>

  <div id="toast-container"></div>

  <script src="conexion.js"></script>
  <script>
    // Mostrar nombre e ID de clase desde localStorage
    document.getElementById("nombreAlumno").textContent = localStorage.getItem("alumno") || "Alumno";
    document.getElementById("nombreClase").textContent = localStorage.getItem("clase") || "Clase";

    // Generar los botones para los d√≠as de la semana
    function generarBotonesPorDia() {
      const dias = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes"];
      const contenedor = document.getElementById("semana-estudios");
      contenedor.innerHTML = "";

      const hoy = new Date();
      const diaActualTexto = dias[hoy.getDay() % 7];

      dias.forEach(diaTexto => {
        const btn = document.createElement("button");
        btn.className = `dia-btn${diaTexto === diaActualTexto ? " dia-actual" : ""}`;
        btn.textContent = diaTexto;
        btn.onclick = () => cargarEstudioPorDia(diaTexto);
        contenedor.appendChild(btn);
      });
    }

    // Cargar el estudio por d√≠a desde la API de Google Sheets
    function cargarEstudioPorDia(dia) {
      const urlConDia = `${URL}?accion=cargarEstudioPorDia&dia=${dia}`;
      fetch(urlConDia)
        .then(res => res.json())
        .then(data => {
          const card = document.querySelector('.study-card');
          if (!data || data.error) {
            card.innerHTML = `<p>${data.error || "No se encontr√≥ ning√∫n estudio disponible."}</p>`;
            return;
          }

          let contenidoHTML = `<h2>Estudio para el d√≠a ${dia}</h2>`;

          data.preguntas.forEach((item, index) => {
            const respuestas = (item.Respuesta || "")
              .split('<br>')
              .map(r => r.trim())
              .filter(r => r.length > 0)
              .slice(0, 3);

            const notaId = `notaPersonal_${dia}_${index}`;
            const respuestaId = `respuesta_${dia}_${index}`;
            const notaGuardada = localStorage.getItem(notaId) || "";
            const respuestaGuardada = localStorage.getItem(respuestaId) || "";

            contenidoHTML += `<div class="bloque-pregunta">`;

            if (item.T√≠tulo) contenidoHTML += `<p><strong>${item.T√≠tulo.replace(/\n/g, "<br>")}</strong></p>`;
            if (item.Pregunta) contenidoHTML += `<p><strong>${item.Pregunta}</strong></p>`;

            if (item.Versiculo) {
              contenidoHTML += `
                <button class="btn-mini" onclick="toggleVisibility('versiculo${index}')">üìñ Mostrar/Ocultar vers√≠culo</button>
                <div id="versiculo${index}" style="display: none;">
                  <div class="versiculo-box"><strong>Vers√≠culo:</strong> ${item.Versiculo}</div>
                </div>`;
            }

            if (item.Nota) {
              contenidoHTML += `
                <button class="btn-mini" onclick="toggleVisibility('nota${index}')">üìú Mostrar/Ocultar nota</button>
                <div id="nota${index}" style="display: none;">
                  <div class="nota-box"><strong>Nota:</strong> ${item.Nota}</div>
                </div>`;
            }

            if (respuestas.length > 0) {
              contenidoHTML += `
                <button class="btn-mini" onclick="toggleVisibility('respuesta${index}')">‚úÖ Mostrar/Ocultar respuestas</button>
                <div class="respuesta" id="respuesta${index}" style="display: none;">
                  <p><strong>Respuesta:</strong></p>
                  ${respuestas.map(r => {
                    const letra = r.charAt(0);
                    const checked = respuestaGuardada === letra ? 'checked' : '';
                    return `<label><input type="radio" name="respuesta${index}" value="${letra}" ${checked} onclick="guardarRespuesta('${respuestaId}', '${letra}')"> ${r}</label>`;
                  }).join('<br>')}
                  <p id="resultado_${respuestaId}" data-correcta="${item.Correcta || ''}" style="margin-top:8px;"></p>
                </div>`;
            }

            contenidoHTML += `
              <div class="nota-personal" style="margin-top: 15px;">
                <label><strong>‚úçÔ∏è Mis notas personales:</strong></label><br>
                <textarea id="${notaId}" oninput="guardarNota('${notaId}')" placeholder="Escribe aqu√≠ tu reflexi√≥n...">${notaGuardada}</textarea>
              </div>
              <hr style="margin: 25px 0; border: none; border-top: 1px solid #ccc;">
            </div>`;
          });

          card.innerHTML = contenidoHTML;

          // Verificar las respuestas previas
          data.preguntas.forEach((item, index) => {
            const respuestaId = `respuesta_${dia}_${index}`;
            const valor = localStorage.getItem(respuestaId);
            if (valor) verificarRespuesta(respuestaId, valor);
          });
        })
        .catch(err => {
          document.querySelector('.study-card').innerHTML = '<p>Error al cargar el estudio.</p>';
          console.error('Error al obtener estudio:', err);
        });
    }

    // Funci√≥n para mostrar u ocultar los elementos
    function toggleVisibility(id) {
      const el = document.getElementById(id);
      el.style.display = (el.style.display === 'none') ? 'block' : 'none';
    }

    // Guardar las notas del alumno
    function guardarNota(id) {
      const contenido = document.getElementById(id).value;
      localStorage.setItem(id, contenido);
    }

    // Guardar la respuesta del alumno
    function guardarRespuesta(id, valor) {
      localStorage.setItem(id, valor);
      verificarRespuesta(id, valor);
    }

    // Verificar si la respuesta es correcta o incorrecta
    function verificarRespuesta(id, valor) {
      const resultadoEl = document.getElementById(`resultado_${id}`);
      const correcta = resultadoEl.dataset.correcta;
      if (!correcta) return;

      resultadoEl.textContent = (valor === correcta) ? "‚úî Correcto" : "‚úñ Incorrecto";
      resultadoEl.style.color = (valor === correcta) ? "green" : "red";
    }

    // Al cargar, generar los botones para los d√≠as
    window.onload = function () {
      const savedUser = localStorage.getItem('sabadoUser');
      if (savedUser) {
        showWelcome(savedUser);
      }
      generarBotonesPorDia();
    };
  </script>

</body>
</html>
